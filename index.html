<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°ã®å¤§ãã•ä¿¡å·æ©Ÿ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f0f9ff;
            user-select: none;
        }

        /* ä¿¡å·æ©Ÿã®æœ¬ä½“ */
        .traffic-light-body {
            background: #2d3748;
            border-radius: 40px;
            padding: 20px;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.2), inset 5px 5px 15px rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 140px;
            margin: 0 auto;
            position: relative;
        }

        /* ä¿¡å·æ©Ÿã®ãƒ©ã‚¤ãƒˆå…±é€š */
        .light {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #4a5568; /* æ¶ˆç¯æ™‚ */
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* å…‰æ²¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .light::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 20%;
            width: 30%;
            height: 20%;
            border-radius: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.1));
            filter: blur(1px);
        }

        /* ç‚¹ç¯çŠ¶æ…‹ */
        .light.blue.active {
            background-color: #3b82f6;
            box-shadow: 0 0 40px #3b82f6, inset 0 0 20px #93c5fd;
        }
        .light.yellow.active {
            background-color: #eab308;
            box-shadow: 0 0 40px #eab308, inset 0 0 20px #fde047;
        }
        .light.red.active {
            background-color: #ef4444;
            box-shadow: 0 0 50px #ef4444, inset 0 0 20px #fca5a5;
            animation: pulseRed 0.8s infinite alternate;
        }

        @keyframes pulseRed {
            from { transform: scale(1); box-shadow: 0 0 30px #ef4444; }
            to { transform: scale(1.05); box-shadow: 0 0 60px #ef4444; }
        }

        /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
        .meter-container {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .meter-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #3b82f6, #eab308, #ef4444);
            transition: width 0.1s linear;
        }

        /* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ */
        .status-icon {
            font-size: 3rem;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .bounce {
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 25px rgba(148, 163, 184, 0.2);
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ */
        .mode-btn {
            transition: all 0.2s;
        }
        .mode-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }

        /* ã‚·ã‚§ã‚¤ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè­¦å‘Šæ™‚ï¼‰ */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        #settingsModal.hidden {
            display: none;
        }
        #settingsModal:not(.hidden) {
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative">

    <!-- è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ (å³ä¸Š) -->
    <button id="menuBtn" class="fixed top-4 right-4 z-40 bg-white/80 p-3 rounded-full shadow-md text-slate-500 hover:text-blue-600 hover:bg-white transition" title="è©³ç´°è¨­å®š">
        <i class="fa-solid fa-bars text-2xl"></i>
    </button>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="glass-panel w-full max-w-4xl p-6 md:p-8 flex flex-col md:flex-row gap-8 items-center justify-center relative z-10">
        
        <!-- å·¦å´ï¼šä¿¡å·æ©Ÿã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ -->
        <div class="flex flex-col items-center gap-6 flex-1">
            <h1 class="text-2xl md:text-3xl font-black text-slate-700 tracking-wider text-center">
                <i class="fa-solid fa-microphone-lines mr-2 text-blue-500"></i>å£°ã®å¤§ãã•ä¿¡å·æ©Ÿ
            </h1>

            <div class="flex items-end justify-center gap-8">
                <!-- ä¿¡å·æ©Ÿ -->
                <div class="traffic-light-body" id="trafficLight">
                    <div class="light red" id="lightRed">
                        <i class="fa-solid fa-exclamation text-3xl text-white opacity-50"></i>
                    </div>
                    <div class="light yellow" id="lightYellow">
                        <i class="fa-solid fa-bell text-3xl text-white opacity-50"></i>
                    </div>
                    <div class="light blue active" id="lightBlue">
                        <i class="fa-solid fa-music text-3xl text-white opacity-50"></i>
                    </div>
                </div>

                <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="flex flex-col items-center justify-end h-full pb-4 w-32">
                    <div id="statusIcon" class="status-icon text-6xl mb-2">ğŸ¦‰</div>
                    <div id="statusText" class="text-xl font-bold text-slate-600 bg-white px-3 py-1 rounded-full shadow-sm">é™ã‹ã§ã™</div>
                </div>
            </div>

            <!-- ãƒ¡ãƒ¼ã‚¿ãƒ¼ -->
            <div class="w-full max-w-sm">
                <div class="flex justify-between text-xs font-bold text-slate-400 mb-1 px-1">
                    <span>é™ã‹</span>
                    <span>æ³¨æ„</span>
                    <span>ã†ã‚‹ã•ã„</span>
                </div>
                <div class="meter-container">
                    <div id="audioLevelBar" class="meter-bar"></div>
                    <!-- ã—ãã„å€¤ãƒãƒ¼ã‚«ãƒ¼ -->
                    <div id="markerYellow" class="absolute top-0 bottom-0 w-1 bg-white/50 border-l border-slate-400 border-dashed transition-all duration-300" style="left: 50%"></div>
                    <div id="markerRed" class="absolute top-0 bottom-0 w-1 bg-white/50 border-l border-red-500 border-dashed transition-all duration-300" style="left: 80%"></div>
                </div>
                <div class="text-right text-xs text-slate-400 mt-1">ç¾åœ¨ã®éŸ³é‡ãƒ¬ãƒ™ãƒ«: <span id="volValue">0</span>%</div>
            </div>
        </div>

        <!-- å³å´ï¼šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="flex flex-col gap-6 w-full md:w-80 bg-slate-50 p-6 rounded-2xl border border-slate-200">
            
            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div class="text-center">
                <button id="startBtn" class="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg transform transition active:scale-95 text-xl flex items-center justify-center gap-2">
                    <i class="fa-solid fa-power-off"></i> æ¸¬å®šã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
                <p class="text-xs text-slate-500 mt-2">â€»ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
            </div>

            <hr class="border-slate-200">

            <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
            <div>
                <label class="block text-sm font-bold text-slate-600 mb-3"><i class="fa-solid fa-sliders mr-1"></i> æ„Ÿåº¦ãƒ¢ãƒ¼ãƒ‰è¨­å®š</label>
                <div class="grid grid-cols-1 gap-2">
                    <!-- data-modeå±æ€§ã‚’è¿½åŠ ã—ã¾ã—ãŸ -->
                    <button class="mode-btn active px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-600 font-bold flex items-center justify-between" data-mode="study" onclick="setMode('study')">
                        <span><i class="fa-solid fa-book-open mr-2"></i>è‡ªç¿’ãƒ¢ãƒ¼ãƒ‰</span>
                        <span class="text-xs font-normal bg-slate-100 px-2 py-1 rounded">å³ã—ã„</span>
                    </button>
                    <button class="mode-btn px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-600 font-bold flex items-center justify-between" data-mode="class" onclick="setMode('class')">
                        <span><i class="fa-solid fa-chalkboard-user mr-2"></i>æˆæ¥­ãƒ¢ãƒ¼ãƒ‰</span>
                        <span class="text-xs font-normal bg-slate-100 px-2 py-1 rounded">æ¨™æº–</span>
                    </button>
                    <button class="mode-btn px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-600 font-bold flex items-center justify-between" data-mode="group" onclick="setMode('group')">
                        <span><i class="fa-solid fa-users mr-2"></i>ã‚°ãƒ«ãƒ¼ãƒ—æ´»å‹•</span>
                        <span class="text-xs font-normal bg-slate-100 px-2 py-1 rounded">å¯›å®¹</span>
                    </button>
                </div>
            </div>

            <!-- ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ -->
            <div class="bg-red-50 border border-red-100 rounded-xl p-4 flex justify-between items-center">
                <div>
                    <div class="text-xs font-bold text-red-400">æ³¨æ„å›æ•°</div>
                    <div class="text-3xl font-black text-red-500" id="alertCount">0</div>
                </div>
                <button onclick="resetCount()" class="text-sm bg-white text-red-400 hover:text-red-600 border border-red-200 px-3 py-1 rounded-lg shadow-sm">
                    <i class="fa-solid fa-rotate-right"></i> ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>

            <!-- è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="flex items-center gap-2 mt-2">
                <input type="checkbox" id="soundToggle" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" checked>
                <label for="soundToggle" class="text-sm font-bold text-slate-600 cursor-pointer select-none">è­¦å‘ŠéŸ³ã‚’é³´ã‚‰ã™ï¼ˆå„ªã—ã„éŸ³ï¼‰</label>
            </div>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-100">
                <h2 class="text-xl font-bold text-slate-700"><i class="fa-solid fa-sliders mr-2 text-blue-500"></i>æ„Ÿåº¦ãƒ»ã—ãã„å€¤èª¿æ•´</h2>
                <button id="closeMenuBtn" class="text-slate-400 hover:text-slate-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="space-y-8">
                <!-- Sensitivity -->
                <div>
                    <div class="flex justify-between mb-2 items-end">
                        <label class="font-bold text-slate-600 text-sm">
                            ãƒã‚¤ã‚¯æ„Ÿåº¦
                            <span class="text-xs font-normal text-slate-400 block">ãƒã‚¤ã‚¯ã®æ‹¾ã„ã‚„ã™ã•</span>
                        </label>
                        <span id="valSensitivity" class="text-blue-600 font-bold text-lg">1.5</span>
                    </div>
                    <input type="range" id="rangeSensitivity" min="0.1" max="5.0" step="0.1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>éˆæ„Ÿ</span>
                        <span>æ•æ„Ÿ</span>
                    </div>
                </div>

                <!-- Yellow Threshold -->
                <div>
                    <div class="flex justify-between mb-2 items-end">
                        <label class="font-bold text-slate-600 text-sm">
                            <i class="fa-solid fa-circle text-yellow-400 mr-1"></i>é»„è‰²ã«ãªã‚‹ãƒ¬ãƒ™ãƒ«
                        </label>
                        <span id="valYellow" class="text-yellow-600 font-bold text-lg">40%</span>
                    </div>
                    <input type="range" id="rangeYellow" min="10" max="90" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-yellow-400">
                </div>

                <!-- Red Threshold -->
                <div>
                    <div class="flex justify-between mb-2 items-end">
                        <label class="font-bold text-slate-600 text-sm">
                            <i class="fa-solid fa-circle text-red-500 mr-1"></i>èµ¤è‰²ã«ãªã‚‹ãƒ¬ãƒ™ãƒ«
                        </label>
                        <span id="valRed" class="text-red-600 font-bold text-lg">70%</span>
                    </div>
                    <input type="range" id="rangeRed" min="20" max="100" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500">
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-slate-100 flex justify-end">
                 <button id="closeMenuBtn2" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition">
                    å®Œäº†
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="mt-8 text-center text-slate-400 text-sm relative z-10">
        <p>éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œãšã€ãŠä½¿ã„ã®ç«¯æœ«å†…ã§ã®ã¿å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
    </div>

    <script>
        // è¨­å®šå€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æˆæ¥­ãƒ¢ãƒ¼ãƒ‰ï¼‰
        let CONFIG = {
            thresholdYellow: 40,
            thresholdRed: 70,
            sensitivity: 1.5, // ãƒã‚¤ã‚¯å…¥åŠ›ã®å¢—å¹…ç‡
            samplingInterval: 50 // ms
        };

        // ãƒ¢ãƒ¼ãƒ‰å®šç¾©
        const MODES = {
            study: { yellow: 20, red: 45, sensitivity: 2.0, name: "è‡ªç¿’ãƒ¢ãƒ¼ãƒ‰" },
            class: { yellow: 40, red: 70, sensitivity: 1.5, name: "æˆæ¥­ãƒ¢ãƒ¼ãƒ‰" },
            group: { yellow: 70, red: 90, sensitivity: 0.8, name: "ã‚°ãƒ«ãƒ¼ãƒ—æ´»å‹•" }
        };

        // DOMè¦ç´ 
        const lights = {
            red: document.getElementById('lightRed'),
            yellow: document.getElementById('lightYellow'),
            blue: document.getElementById('lightBlue')
        };
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const levelBar = document.getElementById('audioLevelBar');
        const volValue = document.getElementById('volValue');
        const startBtn = document.getElementById('startBtn');
        const alertCountDisplay = document.getElementById('alertCount');
        const markerYellow = document.getElementById('markerYellow');
        const markerRed = document.getElementById('markerRed');
        const trafficLightBody = document.getElementById('trafficLight');

        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨DOM
        const menuBtn = document.getElementById('menuBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const closeMenuBtn2 = document.getElementById('closeMenuBtn2');
        const rangeSensitivity = document.getElementById('rangeSensitivity');
        const rangeYellow = document.getElementById('rangeYellow');
        const rangeRed = document.getElementById('rangeRed');
        const valSensitivity = document.getElementById('valSensitivity');
        const valYellow = document.getElementById('valYellow');
        const valRed = document.getElementById('valRed');


        // å¤‰æ•°
        let audioContext;
        let analyser;
        let microphone;
        let isRunning = false;
        let alertCount = 0;
        let currentStatus = 'blue'; // blue, yellow, red
        let redStayCounter = 0; // èµ¤çŠ¶æ…‹ã®æŒç¶šã‚«ã‚¦ãƒ³ã‚¿ï¼ˆä¸€ç¬ã®ã‚¹ãƒ‘ã‚¤ã‚¯ã§åå¿œã•ã›ãªã„ãŸã‚ï¼‰
        let lastAlertTime = 0; // éŸ³ã®é€£æ‰“é˜²æ­¢

        // å‹•ç‰©ã‚¢ã‚¤ã‚³ãƒ³
        const ICONS = {
            blue: 'ğŸ¦‰', // é™ã‹
            yellow: 'ğŸ¤', // å°‘ã—ã–ã‚ã¤ã„ã¦ã„ã‚‹
            red: 'ğŸ¦'   // ã†ã‚‹ã•ã„
        };
        const TEXTS = {
            blue: 'é™ã‹ã§ã™',
            yellow: 'å°‘ã—å£°ãŒå¤§ãã„ï¼Ÿ',
            red: 'å£°ã‚’ãŠã•ãˆã¦ï¼'
        };

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
        function setMode(modeKey) {
            const setting = MODES[modeKey];
            
            // CONFIGã‚’æ›´æ–°
            CONFIG.thresholdYellow = setting.yellow;
            CONFIG.thresholdRed = setting.red;
            CONFIG.sensitivity = setting.sensitivity;

            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚‚åŒæœŸ
            updateSlidersFromConfig();

            // UIæ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ï¼‰
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            const activeBtn = document.querySelector(`.mode-btn[data-mode="${modeKey}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            updateMarkerPositions();
            console.log(`Mode switched to: ${setting.name}`);
        }

        // ãƒãƒ¼ã‚«ãƒ¼ä½ç½®ã®æ›´æ–°
        function updateMarkerPositions() {
            markerYellow.style.left = `${CONFIG.thresholdYellow}%`;
            markerRed.style.left = `${CONFIG.thresholdRed}%`;
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚ã®å‡¦ç†
        function setupSliders() {
            // Sensitivity
            rangeSensitivity.addEventListener('input', (e) => {
                CONFIG.sensitivity = parseFloat(e.target.value);
                valSensitivity.innerText = CONFIG.sensitivity.toFixed(1);
                clearModeActiveState(); // æ‰‹å‹•æ“ä½œã—ãŸã®ã§ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚’å¤–ã™ï¼ˆè¦‹ãŸç›®ä¸Šï¼‰
            });

            // Yellow Threshold
            rangeYellow.addEventListener('input', (e) => {
                let val = parseInt(e.target.value);
                // èµ¤ã‚ˆã‚Šå¤§ãããªã‚‰ãªã„ã‚ˆã†ã«åˆ¶å¾¡ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                if (val >= CONFIG.thresholdRed) {
                    val = CONFIG.thresholdRed - 1;
                    rangeYellow.value = val;
                }
                CONFIG.thresholdYellow = val;
                valYellow.innerText = val + '%';
                updateMarkerPositions();
                clearModeActiveState();
            });

            // Red Threshold
            rangeRed.addEventListener('input', (e) => {
                let val = parseInt(e.target.value);
                // é»„è‰²ã‚ˆã‚Šå°ã•ããªã‚‰ãªã„ã‚ˆã†ã«åˆ¶å¾¡
                if (val <= CONFIG.thresholdYellow) {
                    val = CONFIG.thresholdYellow + 1;
                    rangeRed.value = val;
                }
                CONFIG.thresholdRed = val;
                valRed.innerText = val + '%';
                updateMarkerPositions();
                clearModeActiveState();
            });
        }

        function updateSlidersFromConfig() {
            rangeSensitivity.value = CONFIG.sensitivity;
            valSensitivity.innerText = CONFIG.sensitivity.toFixed(1);

            rangeYellow.value = CONFIG.thresholdYellow;
            valYellow.innerText = CONFIG.thresholdYellow + '%';

            rangeRed.value = CONFIG.thresholdRed;
            valRed.innerText = CONFIG.thresholdRed + '%';
        }

        // æ‰‹å‹•èª¿æ•´æ™‚ã«ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        function clearModeActiveState() {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        function toggleModal(show) {
            if (show) {
                settingsModal.classList.remove('hidden');
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ä»Šã®è¨­å®šå€¤ã«åˆã‚ã›ã‚‹ï¼ˆå¿µã®ãŸã‚ï¼‰
                updateSlidersFromConfig();
            } else {
                settingsModal.classList.add('hidden');
            }
        }

        menuBtn.addEventListener('click', () => toggleModal(true));
        closeMenuBtn.addEventListener('click', () => toggleModal(false));
        closeMenuBtn2.addEventListener('click', () => toggleModal(false));
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) toggleModal(false);
        });

        // ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚¹ãƒˆãƒƒãƒ—å‡¦ç†
        startBtn.addEventListener('click', async () => {
            if (isRunning) {
                stopAudio();
            } else {
                await startAudio();
            }
        });

        async function startAudio() {
            try {
                // AudioContextã®ä½œæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…é ˆï¼‰
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ãƒã‚¤ã‚¯å…¥åŠ›ã®å–å¾—
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                microphone.connect(analyser);

                isRunning = true;
                startBtn.innerHTML = '<i class="fa-solid fa-stop"></i> æ¸¬å®šåœæ­¢';
                startBtn.classList.remove('from-blue-500', 'to-indigo-600');
                startBtn.classList.add('from-red-500', 'to-pink-600');
                
                analyzeLoop();

            } catch (err) {
                console.error("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
                alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚ŒãŸã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function stopAudio() {
            if (microphone) microphone.disconnect();
            if (analyser) analyser.disconnect();
            if (audioContext) audioContext.close();
            
            isRunning = false;
            startBtn.innerHTML = '<i class="fa-solid fa-power-off"></i> æ¸¬å®šã‚¹ã‚¿ãƒ¼ãƒˆ';
            startBtn.classList.add('from-blue-500', 'to-indigo-600');
            startBtn.classList.remove('from-red-500', 'to-pink-600');
            
            // UIãƒªã‚»ãƒƒãƒˆ
            updateTrafficLight('blue');
            levelBar.style.width = '0%';
            volValue.innerText = '0';
        }

        // è§£æãƒ«ãƒ¼ãƒ—
        function analyzeLoop() {
            if (!isRunning) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            // RMS (äºŒä¹—å¹³å‡å¹³æ–¹æ ¹) ã‚’è¨ˆç®—ã—ã¦éŸ³é‡ã‚’å–å¾—
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                const x = (dataArray[i] - 128) / 128.0; // -1 to 1
                sum += x * x;
            }
            let rms = Math.sqrt(sum / bufferLength);

            // éŸ³é‡ã‚’0-100ã®ã‚¹ã‚±ãƒ¼ãƒ«ã«å¤‰æ›ï¼ˆæ„Ÿåº¦èª¿æ•´è¾¼ã¿ï¼‰
            // é€šå¸¸rmsã¯0.0~0.5ãã‚‰ã„ãŒå¤šã„ã®ã§ã€ãã‚Œã‚’æ‹¡å¼µã™ã‚‹
            let volume = Math.min(100, Math.floor(rms * 400 * CONFIG.sensitivity));

            updateUI(volume);

            requestAnimationFrame(analyzeLoop);
        }

        // UIæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
        function updateUI(volume) {
            // ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°
            levelBar.style.width = `${volume}%`;
            volValue.innerText = volume;

            // çŠ¶æ…‹åˆ¤å®š
            let nextStatus = 'blue';

            // ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ï¼ˆä¸€ç¬ã®ãƒ”ãƒ¼ã‚¯å¯¾ç­–ï¼‰
            if (volume > CONFIG.thresholdRed) {
                redStayCounter++;
            } else {
                redStayCounter = Math.max(0, redStayCounter - 1);
            }

            if (redStayCounter > 5 || volume > CONFIG.thresholdRed + 10) { 
                // ç¶™ç¶šã—ã¦ã†ã‚‹ã•ã„ã€ã¾ãŸã¯çªç™ºçš„ã«ã™ã”ãã†ã‚‹ã•ã„
                nextStatus = 'red';
            } else if (volume > CONFIG.thresholdYellow) {
                nextStatus = 'yellow';
            } else {
                nextStatus = 'blue';
            }

            // çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸæ™‚ã®ã¿å‡¦ç†
            if (currentStatus !== nextStatus) {
                // é»„è‰²â†’èµ¤ã«å¤‰ã‚ã£ãŸã¨ãã®ã¿ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
                if (nextStatus === 'red' && currentStatus !== 'red') {
                    incrementAlert();
                    playSound('alert');
                    trafficLightBody.classList.add('shake');
                    setTimeout(() => trafficLightBody.classList.remove('shake'), 500);
                } else if (nextStatus === 'yellow' && currentStatus === 'blue') {
                    // é’â†’é»„
                    playSound('chirp');
                }

                updateTrafficLight(nextStatus);
                currentStatus = nextStatus;
            }
        }

        // ä¿¡å·æ©Ÿã¨ã‚¢ã‚¤ã‚³ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
        function updateTrafficLight(status) {
            // å…¨æ¶ˆç¯
            lights.red.classList.remove('active');
            lights.yellow.classList.remove('active');
            lights.blue.classList.remove('active');

            // å¯¾è±¡ç‚¹ç¯
            lights[status].classList.add('active');

            // ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
            statusIcon.innerText = ICONS[status];
            statusText.innerText = TEXTS[status];

            // è‰²ã«å¿œã˜ãŸã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
            if (status === 'red') {
                statusText.className = "text-xl font-bold text-red-600 bg-red-50 px-3 py-1 rounded-full shadow-sm border border-red-200";
                statusIcon.classList.add('bounce');
            } else if (status === 'yellow') {
                statusText.className = "text-xl font-bold text-yellow-600 bg-yellow-50 px-3 py-1 rounded-full shadow-sm border border-yellow-200";
                statusIcon.classList.remove('bounce');
            } else {
                statusText.className = "text-xl font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full shadow-sm border border-blue-200";
                statusIcon.classList.remove('bounce');
            }
        }

        function incrementAlert() {
            alertCount++;
            alertCountDisplay.innerText = alertCount;
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            alertCountDisplay.style.transform = "scale(1.5)";
            setTimeout(() => {
                alertCountDisplay.style.transform = "scale(1)";
            }, 200);
        }

        function resetCount() {
            alertCount = 0;
            alertCountDisplay.innerText = 0;
        }

        // Web Audio APIã‚’ä½¿ã£ãŸç°¡æ˜“ã‚µã‚¦ãƒ³ãƒ‰ç”Ÿæˆï¼ˆmp3ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ï¼‰
        function playSound(type) {
            if (!document.getElementById('soundToggle').checked) return;
            
            // çŸ­æ™‚é–“ã§ã®é€£ç¶šå†ç”Ÿé˜²æ­¢
            const now = Date.now();
            if (now - lastAlertTime < 1000) return; 
            lastAlertTime = now;

            const ctx = audioContext;
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();

            osc.connect(gainNode);
            gainNode.connect(ctx.destination);

            if (type === 'alert') {
                // å„ªã—ã„è­¦å‘ŠéŸ³ï¼ˆãƒãƒ³ãƒƒã¨ã„ã†éŸ³ï¼‰
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                osc.start();
                osc.stop(ctx.currentTime + 0.3);

            } else if (type === 'chirp') {
                // é³¥ã®ã•ãˆãšã‚Šé¢¨ï¼ˆãƒ”ãƒ¨ãƒƒï¼‰
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);

                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            }
        }

        // åˆæœŸåŒ–
        setupSliders();
        setMode('class');
    </script>
</body>
</html>